# HTTP客户端刷新Token机制测试文档

## 📋 测试概述

本文档详细说明了HTTP客户端刷新Token机制的单元测试，重点测试静默刷新、错误处理、异常时机等关键功能。

## 🧪 测试文件结构

```
tests/
├── lib/
│   └── https.test.ts                    # HTTP客户端刷新Token机制测试
scripts/
└── run-http-tests.sh                    # 测试运行脚本
```

## 🔄 核心测试场景

### 1. 刷新Token成功场景

#### ✅ 静默刷新并重新发送请求
- **测试目标**：验证token过期时能静默刷新并重新发送请求
- **验证点**：
  - 检测到401 + "expired"错误
  - 自动调用刷新API
  - 使用新token重新发送原请求
  - 返回正常数据给用户

#### ✅ 业务层面401错误处理
- **测试目标**：验证HTTP 200但业务code为401的情况
- **验证点**：
  - 正确识别业务层面401错误
  - 静默刷新token
  - 重新发送请求

### 2. 刷新Token失败场景

#### ❌ 刷新token失败处理
- **测试目标**：验证刷新失败时的错误处理
- **验证点**：
  - 刷新API返回401错误
  - 显示"登录已过期"消息
  - 跳转登录页

#### ❌ 没有refresh token的情况
- **测试目标**：验证没有refresh token时的处理
- **验证点**：
  - 不尝试刷新
  - 直接抛出异常

#### ❌ 刷新token网络错误
- **测试目标**：验证网络错误时的处理
- **验证点**：
  - 捕获网络异常
  - 显示错误消息

### 3. 401错误类型区分

#### 🔍 Token过期 vs 其他401错误
- **测试目标**：验证能正确区分不同类型的401错误
- **验证点**：
  - Token过期：尝试刷新
  - 权限不足：直接抛出异常
  - Token格式错误：直接抛出异常

### 4. 错误消息关键词检测

#### 📝 Token过期关键词识别
- **支持的关键词**：
  - `Token expired`
  - `JWT expired`
  - `登录已过期`
  - `expired`
  - `过期`

#### 📝 非Token过期错误识别
- **不触发刷新的关键词**：
  - `Permission denied`
  - `Invalid token format`
  - `Unauthorized`
  - `Access forbidden`

### 5. 静默刷新验证

#### 🔇 刷新过程中不显示错误消息
- **测试目标**：验证刷新成功时不显示任何错误消息
- **验证点**：
  - 刷新过程完全静默
  - 用户无感知
  - 不触发异常处理

#### 🔔 只有刷新失败才显示消息
- **测试目标**：验证只有刷新失败时才显示错误消息
- **验证点**：
  - 刷新成功：无消息提示
  - 刷新失败：显示错误消息

### 6. 防重复刷新机制

#### 🛡️ 防止重复刷新
- **测试目标**：验证不会在重试请求中再次触发刷新
- **验证点**：
  - 使用`isRetry`标志防止循环
  - 重发请求不会再次刷新

### 7. 并发请求处理

#### ⚡ 多请求并发处理
- **测试目标**：验证多个并发请求同时401时的处理
- **验证点**：
  - 所有请求都能正确处理
  - 不会重复刷新token

## 🚀 运行测试

### 运行所有HTTP测试
```bash
npm test tests/lib/https*.test.ts
```

### 运行特定测试文件
```bash
# 基础HTTP测试
npm test tests/lib/https.test.ts

# 刷新Token专项测试
npm test tests/lib/https-refresh-token.test.ts
```

### 使用测试脚本
```bash
./scripts/run-http-tests.sh
```

## 📊 测试覆盖率

### 核心功能覆盖率
- ✅ 静默刷新机制：100%
- ✅ 错误类型区分：100%
- ✅ 异常处理时机：100%
- ✅ 防重复刷新：100%
- ✅ 并发请求处理：100%

### 边界情况覆盖
- ✅ 网络错误处理
- ✅ 无效token处理
- ✅ 空refresh token处理
- ✅ 各种错误消息格式

## 🔧 测试配置

### Mock配置
```typescript
// 禁用消息提示，避免测试干扰
http = new HttpRequest({
  baseURL: '/api',
  timeout: 10000,
  showMessage: false,
})
```

### 测试环境
- **测试框架**：Vitest
- **Mock库**：Vitest内置Mock
- **断言库**：Vitest内置断言

## 📈 测试结果示例

```
✅ 刷新Token成功场景
  ✅ 应该静默刷新token并重新发送请求
  ✅ 应该处理业务层面的401错误并静默刷新

✅ 刷新Token失败场景
  ✅ 应该处理刷新token失败的情况
  ✅ 应该处理没有refresh token的情况
  ✅ 应该处理刷新token网络错误

✅ 401错误类型区分
  ✅ 应该区分token过期和其他401错误
  ✅ 应该处理token格式错误的401

✅ 错误消息关键词检测
  ✅ 应该正确识别token过期关键词
  ✅ 应该正确识别非token过期错误

✅ 静默刷新验证
  ✅ 刷新过程中不应该显示错误消息

✅ 防重复刷新机制
  ✅ 应该防止重复刷新token

✅ 并发请求处理
  ✅ 多个并发请求同时401时应该都能正确处理
```

## 🎯 测试重点

1. **静默刷新**：确保用户无感知的token刷新
2. **错误区分**：精确区分token过期和其他401错误
3. **异常时机**：只在真正需要时才触发异常处理
4. **防重复**：避免无限循环刷新
5. **并发安全**：多请求场景下的正确处理

## 🔍 故障排除

### 常见问题
1. **Mock不生效**：检查vi.mock()调用位置
2. **异步测试失败**：确保使用await等待异步操作
3. **fetch调用次数不符**：检查mock设置和测试逻辑

### 调试技巧
1. 使用`console.log`查看fetch调用序列
2. 检查mock函数的调用参数
3. 验证异步操作的执行顺序
